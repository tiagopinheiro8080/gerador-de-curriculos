<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de Currículos PRO — por Tiago Pinheiro</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet"/>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- PWA -->
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" type="image/png" href="https://placehold.co/32x32/0b1220/FFFFFF?text=CV"/>

  <style>
    :root{
      --bg-1:#0b1220; --glass:#111827cc; --glass-border:#ffffff1a;
    }
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(1000px 500px at -10% -10%, rgba(59,130,246,.15), transparent 60%),
        radial-gradient(900px 480px at 110% 0%, rgba(16,185,129,.12), transparent 65%),
        linear-gradient(180deg,#0b1220 0%,#0f172a 100%);
      color:#e5e7eb; min-height:100vh;
    }
    .font-title{font-family:'Montserrat',sans-serif}
    .screen{display:none}
    .active-screen{display:block;animation:fade .4s ease}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .glass{background:var(--glass);border:1px solid var(--glass-border);backdrop-filter:blur(10px)}
    .form-input{width:100%;padding:.75rem .85rem;background:#0b1528;border:1px solid #263142;border-radius:.75rem;color:#e5e7eb;outline:none}
    .form-input:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    #cv-preview-area{width:210mm;min-height:297mm;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .template-selector-card{cursor:pointer;transition:.2s;border:1px solid #334155;background:#0f172acc;border-radius:.75rem;padding:.6rem}
    .template-selector-card:hover{transform:translateY(-2px)}
    .template-selector-card.selected{outline:2px solid #3b82f6;box-shadow:0 0 0 4px rgba(59,130,246,.25)}
    .color-selector-dot{cursor:pointer;transition:.2s;border:2px solid #0b1220;width:34px;height:34px;border-radius:999px}
    .color-selector-dot.selected{transform:scale(1.15);box-shadow:0 0 0 3px white}
    @media print{body{background:#fff}#cv-preview-area{box-shadow:none}}
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="sticky top-0 z-40 bg-black/40 backdrop-blur-lg border-b border-white/10">
    <div class="max-w-7xl mx-auto flex items-center justify-between p-3">
      <h1 class="font-title text-white text-xl">Gerador de Currículos PRO</h1>
      <button onclick="toggleAboutModal()" class="text-gray-300 hover:text-white">Sobre</button>
    </div>
  </header>

  <!-- MODAL -->
  <div id="about-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
    <div class="glass rounded-xl p-8 max-w-lg relative">
      <button onclick="toggleAboutModal()" class="absolute top-2 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
      <h2 class="text-2xl font-bold text-blue-400 mb-4">Sobre o Desenvolvedor</h2>
      <p class="text-gray-300 mb-4">Projeto desenvolvido por <b>Tiago Pinheiro</b> (HTML, Tailwind CSS e JavaScript).</p>
      <a href="https://tiagopinheiro8080.github.io/" target="_blank" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">Ver Portfólio</a>
    </div>
  </div>

  <!-- STEPPER -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 mt-6">
    <ol id="stepper" class="grid grid-cols-3 gap-3"></ol>
  </div>

  <main id="app" class="max-w-7xl mx-auto p-4 sm:p-6">

    <!-- HOME -->
    <section id="home-screen" class="active-screen">
      <div class="glass rounded-2xl p-10 md:p-14 text-center">
        <h1 class="text-4xl md:text-6xl font-title font-bold text-white">Crie seu <span class="text-transparent bg-clip-text bg-gradient-to-tr from-blue-400 to-emerald-400">Currículo Profissional</span></h1>
        <p class="max-w-2xl mx-auto text-gray-300 mt-4">Templates modernos, opção de foto, exportação em PDF e salvamento automático.</p>
        <div class="mt-10 flex items-center justify-center gap-3">
          <button onclick="showScreen('form-screen')" class="px-6 py-3 rounded-xl text-white font-semibold bg-gradient-to-r from-blue-600 to-emerald-500 hover:opacity-95 transition">Começar agora</button>
          <button onclick="showScreen('editor-screen'); fillSampleData();" class="px-6 py-3 rounded-xl border border-white/15 text-gray-100 hover:bg-white/10 transition">Ver exemplo</button>
        </div>
      </div>
    </section>

    <!-- FORM -->
    <section id="form-screen" class="screen">
      <div class="glass rounded-2xl p-6 md:p-8">
        <h2 class="text-3xl font-title font-bold text-white mb-6 text-center">Preencha seus Dados</h2>

        <form id="main-form" class="space-y-8">

          <!-- Dados pessoais -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input id="name" class="form-input" placeholder="Nome Completo">
            <input id="role" class="form-input" placeholder="Cargo Desejado">
            <input id="email" type="email" class="form-input" placeholder="Email">
            <input id="phone" class="form-input" placeholder="Telefone">
            <input id="linkedin" class="form-input" placeholder="LinkedIn (URL)">
            <input id="location" class="form-input" placeholder="Cidade, Estado">
            <div class="md:col-span-2">
              <label class="text-sm text-gray-300 block mb-1" for="photo">Foto (opcional)</label>
              <input id="photo" type="file" accept="image/*" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-500 cursor-pointer" />
            </div>
            <div class="md:col-span-2">
              <label class="text-sm text-gray-300 block mb-1" for="summary">Resumo profissional</label>
              <textarea id="summary" rows="4" class="form-input" placeholder="Fale brevemente sobre suas principais conquistas e competências..."></textarea>
            </div>
          </div>

          <hr class="border-white/10" />

          <!-- Experiência -->
          <div id="experience-section">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold text-blue-300">Experiência Profissional</h3>
              <button type="button" id="add-experience" class="px-3 py-1.5 rounded-lg text-sm bg-blue-600 hover:bg-blue-500">+ Adicionar</button>
            </div>
            <div id="experience-entries" class="space-y-4 mt-4"></div>
          </div>

          <!-- Formação -->
          <div id="education-section" class="mt-2">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold text-blue-300">Formação Acadêmica</h3>
              <button type="button" id="add-education" class="px-3 py-1.5 rounded-lg text-sm bg-blue-600 hover:bg-blue-500">+ Adicionar</button>
            </div>
            <div id="education-entries" class="space-y-4 mt-4"></div>
          </div>

          <!-- Habilidades -->
          <div>
            <h3 class="text-xl font-bold text-blue-300 mb-2">Habilidades</h3>
            <textarea id="skills" rows="3" class="form-input" placeholder="HTML, CSS, JavaScript, Comunicação, Liderança... (separe por vírgulas)"></textarea>
          </div>

          <!-- Idiomas -->
          <div id="languages-section" class="mt-2">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold text-blue-300">Idiomas</h3>
              <button type="button" id="add-language" class="px-3 py-1.5 rounded-lg text-sm bg-blue-600 hover:bg-blue-500">+ Adicionar</button>
            </div>
            <div id="languages-entries" class="space-y-4 mt-4"></div>
          </div>

          <!-- Certificações -->
          <div id="certifications-section" class="mt-2">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold text-blue-300">Certificações</h3>
              <button type="button" id="add-certification" class="px-3 py-1.5 rounded-lg text-sm bg-blue-600 hover:bg-blue-500">+ Adicionar</button>
            </div>
            <div id="certifications-entries" class="space-y-4 mt-4"></div>
          </div>

          <!-- Projetos / Links -->
          <div id="projects-section" class="mt-2">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold text-blue-300">Projetos / Links</h3>
              <button type="button" id="add-project" class="px-3 py-1.5 rounded-lg text-sm bg-blue-600 hover:bg-blue-500">+ Adicionar</button>
            </div>
            <div id="projects-entries" class="space-y-4 mt-4"></div>
          </div>

        </form>

        <div class="flex flex-wrap gap-3 justify-center mt-6">
          <button onclick="showScreen('editor-screen')" class="px-6 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-semibold">Avançar para Editor</button>
          <button onclick="fillSampleData()" class="px-6 py-3 rounded-xl border border-white/15 hover:bg-white/10">Preencher Exemplo</button>
          <button onclick="resetData()" class="px-6 py-3 rounded-xl border border-white/15 hover:bg-white/10">Limpar Dados</button>
        </div>
      </div>
    </section>

    <!-- EDITOR -->
    <section id="editor-screen" class="screen">
      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Sidebar -->
        <aside class="glass rounded-2xl p-6 w-full lg:w-[340px] self-start lg:sticky top-6">
          <h2 class="text-2xl font-title font-bold mb-3">Editor</h2>
          <div class="mt-4">
            <h3 class="text-sm text-blue-300 font-semibold mb-2">Layout do Template</h3>
            <div id="template-selector" class="grid grid-cols-2 gap-3"></div>
          </div>
          <div class="mt-6">
            <h3 class="text-sm text-blue-300 font-semibold mb-2">Cor de Destaque</h3>
            <div id="color-selector" class="flex flex-wrap gap-3"></div>
          </div>
          <hr class="my-6 border-white/10"/>
          <div class="space-y-3">
            <button onclick="showScreen('form-screen')" class="w-full px-4 py-3 rounded-xl border border-white/15 hover:bg-white/10">Editar Informações</button>
            <button id="download-pdf-btn" class="w-full px-4 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-emerald-500 text-white font-semibold flex items-center justify-center gap-2">
              <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor"><path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/></svg>
              Baixar PDF (A4)
            </button>
            <button onclick="fillSampleData()" class="w-full px-4 py-3 rounded-xl border border-white/15 hover:bg-white/10">Preencher Exemplo</button>
            <button onclick="resetData()" class="w-full px-4 py-3 rounded-xl border border-white/15 hover:bg-white/10">Limpar Dados</button>
          </div>
          <p class="text-xs text-gray-400 mt-4">Dica: o PDF será gerado com as páginas necessárias automaticamente.</p>
        </aside>

        <!-- Preview -->
        <section class="flex-1 glass rounded-2xl p-4">
          <div id="cv-preview-container" class="overflow-auto" style="max-height:85vh;">
            <div id="cv-preview-area" class="bg-white text-black mx-auto"></div>
          </div>
        </section>
      </div>
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 mt-8 mb-10 text-sm text-gray-400">
    <div class="flex items-center justify-between">
      <p><i><b>Criado por Tiago Pinheiro</b></i></p>
      <button onclick="toggleAboutModal()" class="hover:text-white transition">Sobre</button>
    </div>
  </footer>

  <!-- ======================= SCRIPT PRINCIPAL ======================= -->
  <script>
    /* ---------------- STATE ---------------- */
    let currentScreen = 'home-screen';
    let selectedTemplate = 'executive';
    let selectedColor = 'blue';
    const STORAGE_KEY = 'cvpro-data-v2';

    const formData = {
      name:'', role:'', email:'', phone:'', linkedin:'', location:'',
      photo:null, summary:'',
      experience:[], education:[], skills:[],
      languages:[], certifications:[], projects:[]
    };

    /* -------------- ELEMENTOS -------------- */
    const screens = {
      home:document.getElementById('home-screen'),
      form:document.getElementById('form-screen'),
      editor:document.getElementById('editor-screen'),
    };
    const previewArea = document.getElementById('cv-preview-area');
    const form = document.getElementById('main-form');
    const templateSelector = document.getElementById('template-selector');
    const colorSelector = document.getElementById('color-selector');
    const aboutModal = document.getElementById('about-modal');
    const stepper = document.getElementById('stepper');

    /* -------------- DADOS -------------- */
    const templates = [
      { id: 'executive',    name: 'Executivo' },
      { id: 'creative',     name: 'Criativo (Foto)', photo:true },
      { id: 'timeline',     name: 'Cronológico' },
      { id: 'modern',       name: 'Moderno' },
      { id: 'compact',      name: 'Compacto' },
      // novos
      { id: 'elegant',      name: 'Elegante' },
      { id: 'professional', name: 'Profissional' },
      { id: 'photoLeft',    name: 'Foto Lateral (Foto)', photo:true },
      { id: 'photoHeader',  name: 'Foto Cabeçalho (Foto)', photo:true },
      { id: 'photoCard',    name: 'Foto em Cartão (Foto)', photo:true },
    ];
    const colors = {
      blue:   { text:'text-blue-600',    bg:'bg-blue-600',    border:'border-blue-600',    ring:'ring-blue-600' },
      green:  { text:'text-emerald-600', bg:'bg-emerald-600', border:'border-emerald-600', ring:'ring-emerald-600' },
      gray:   { text:'text-slate-600',   bg:'bg-slate-600',   border:'border-slate-600',   ring:'ring-slate-600' },
      purple: { text:'text-violet-600',  bg:'bg-violet-600',  border:'border-violet-600',  ring:'ring-violet-600' },
      orange: { text:'text-orange-600',  bg:'bg-orange-600',  border:'border-orange-600',  ring:'ring-orange-600' },
    };

    /* -------------- NAV / UI -------------- */
    function updateStepper(){
      const steps = [
        {id:'home-screen', label:'Início', idx:0},
        {id:'form-screen', label:'Dados', idx:1},
        {id:'editor-screen', label:'Editor', idx:2},
      ];
      const activeIdx = steps.find(s => s.id === currentScreen)?.idx ?? 0;
      stepper.innerHTML = steps.map((s, i) => `
        <li class="flex items-center gap-3 select-none">
          <button onclick="showScreen('${s.id}')"
            class="flex-1 glass rounded-xl px-3 py-2 text-left ${i<=activeIdx ? 'border-blue-500/40' : ''}">
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center justify-center w-7 h-7 rounded-full ${i<activeIdx?'bg-emerald-500 text-white': i===activeIdx?'bg-blue-600 text-white':'bg-white/10'}">
                ${i+1}
              </span>
              <span class="${i===activeIdx ? 'text-white' : 'text-gray-300'} font-medium">${s.label}</span>
            </div>
          </button>
        </li>
      `).join('');
    }

    function showScreen(screenId){
      Object.values(screens).forEach(s => s.classList.remove('active-screen'));
      const key = screenId.split('-')[0];
      screens[key].classList.add('active-screen');
      currentScreen = screenId;
      window.scrollTo(0,0);
      if (screenId === 'editor-screen' || screenId === 'form-screen'){
        populateForm();
        renderCV();
      }
      updateStepper();
    }

    function toggleAboutModal(){ aboutModal.classList.toggle('hidden'); aboutModal.classList.toggle('flex'); }

    /* -------------- ENTRADAS DINÂMICAS -------------- */
    function addDynamicEntry(type, data={}){
      const container = document.getElementById(`${type}-entries`);
      const idx = container.children.length;
      const wrapCls = 'grid grid-cols-1 md:grid-cols-2 gap-3 p-4 rounded-xl bg-[#0b1528] border border-[#263142] relative';
      const wrapper = document.createElement('div'); wrapper.className = wrapCls;

      let fields = '';
      switch(type){
        case 'experience':
          fields = `
            <input data-type="${type}" data-index="${idx}" data-key="title" class="form-input md:col-span-2" placeholder="Cargo" value="${data.title||''}">
            <input data-type="${type}" data-index="${idx}" data-key="company" class="form-input" placeholder="Empresa" value="${data.company||''}">
            <input data-type="${type}" data-index="${idx}" data-key="period" class="form-input" placeholder="Período (ex: 2020 - 2024)" value="${data.period||''}">
            <textarea data-type="${type}" data-index="${idx}" data-key="description" rows="3" class="form-input md:col-span-2" placeholder="Descrição das atividades...">${data.description||''}</textarea>
          `; break;
        case 'education':
          fields = `
            <input data-type="${type}" data-index="${idx}" data-key="institution" class="form-input md:col-span-2" placeholder="Instituição" value="${data.institution||''}">
            <input data-type="${type}" data-index="${idx}" data-key="description" class="form-input" placeholder="Curso / Programa" value="${data.description||''}">
            <select data-type="${type}" data-index="${idx}" data-key="level" class="form-input">
              ${['Fundamental','Médio','Técnico','Tecnólogo','Graduação','Pós-graduação','MBA','Mestrado','Doutorado','Outro']
                .map(l=>`<option ${data.level===l?'selected':''}>${l}</option>`).join('')}
            </select>
            <input data-type="${type}" data-index="${idx}" data-key="period" class="form-input" placeholder="Período (ex: 2018 - 2022)" value="${data.period||''}">
          `; break;
        case 'languages':
          fields = `
            <input data-type="${type}" data-index="${idx}" data-key="name" class="form-input" placeholder="Idioma (ex: Inglês)" value="${data.name||''}">
            <select data-type="${type}" data-index="${idx}" data-key="level" class="form-input">
              ${['Básico','Intermediário','Avançado','Fluente','Nativo'].map(l=>`<option ${data.level===l?'selected':''}>${l}</option>`).join('')}
            </select>
          `; break;
        case 'certifications':
          fields = `
            <input data-type="${type}" data-index="${idx}" data-key="name" class="form-input md:col-span-2" placeholder="Certificação" value="${data.name||''}">
            <input data-type="${type}" data-index="${idx}" data-key="issuer" class="form-input" placeholder="Instituição" value="${data.issuer||''}">
            <input data-type="${type}" data-index="${idx}" data-key="period" class="form-input" placeholder="Ano/Período" value="${data.period||''}">
          `; break;
        case 'projects':
          fields = `
            <input data-type="${type}" data-index="${idx}" data-key="name" class="form-input md:col-span-2" placeholder="Projeto" value="${data.name||''}">
            <input data-type="${type}" data-index="${idx}" data-key="link" class="form-input" placeholder="Link (URL)" value="${data.link||''}">
            <textarea data-type="${type}" data-index="${idx}" data-key="description" rows="2" class="form-input md:col-span-2" placeholder="Descrição do projeto...">${data.description||''}</textarea>
          `; break;
      }

      wrapper.innerHTML = `
        <button type="button" onclick="removeDynamicEntry(this)" class="absolute -top-3 -right-3 w-8 h-8 rounded-full bg-red-500 hover:bg-red-400 text-white font-bold">×</button>
        ${fields}`;
      container.appendChild(wrapper);
    }
    function removeDynamicEntry(btn){ btn.parentElement.remove(); renderCV(); }

    /* -------------- FORM / STATE -------------- */
    function saveState(){
      try{
        const toSave = {...formData, photo:null};
        localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
      }catch(e){}
    }
    function loadState(){
      try{
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) Object.assign(formData, JSON.parse(saved));
      }catch(e){}
    }
    function handlePhotoUpload(e){
      const file = e.target.files[0];
      if(!file){ formData.photo = null; renderCV(); return; }
      const reader = new FileReader();
      reader.onloadend = () => { formData.photo = reader.result; renderCV(); };
      reader.readAsDataURL(file);
    }
    function gatherFormData(){
      const data = {};
      document.querySelectorAll('#main-form [id]').forEach(el => {
        if (el.type !== 'file') data[el.id] = el.value || '';
      });
      data.skills = (data.skills || '').split(',').map(s => s.trim()).filter(Boolean);

      ['experience','education','languages','certifications','projects'].forEach(type => {
        data[type] = [];
        document.querySelectorAll(`#${type}-entries > div`).forEach(div => {
          const entry = {};
          div.querySelectorAll('input, textarea, select').forEach(i => entry[i.dataset.key] = i.value || '');
          data[type].push(entry);
        });
      });

      Object.assign(formData, data);
    }
    function populateForm(){
      Object.keys(formData).forEach(k=>{
        const el = document.getElementById(k);
        if(el && k!=='photo'){
          el.value = k==='skills' ? (Array.isArray(formData.skills)? formData.skills.join(', '):'') : (formData[k]||'');
        }
      });
      ['experience','education','languages','certifications','projects'].forEach(t=>{
        const cont = document.getElementById(`${t}-entries`);
        if(!cont) return;
        cont.innerHTML = '';
        (formData[t]||[]).forEach(d=> addDynamicEntry(t, d));
      });
    }
    function resetData(){
      localStorage.removeItem(STORAGE_KEY);
      Object.assign(formData, {name:'',role:'',email:'',phone:'',linkedin:'',location:'',photo:null,summary:'',experience:[],education:[],skills:[],languages:[],certifications:[],projects:[]});
      populateForm(); renderCV();
    }
    function fillSampleData(){
      Object.assign(formData, {
        name:'Tiago Pinheiro',
        role:'Desenvolvedor Front-end',
        email:'tiago@email.com',
        phone:'(11) 99999-0000',
        linkedin:'linkedin.com/in/tiagopinheiro',
        location:'São Paulo, SP',
        summary:'Front-end focado em acessibilidade, performance e design system. Experiência em React, Tailwind e automação.',
        experience:[
          {title:'Front-end Developer', company:'Acme Tech', period:'2022 — Atual', description:'Liderança de migração para Tailwind, testes e2e e otimização de bundle (-35%).'},
          {title:'UI Engineer', company:'StartApp', period:'2020 — 2022', description:'Criação de design system e componentes reutilizáveis.'}
        ],
        education:[
          {institution:'Universidade X', description:'Sistemas de Informação', level:'Graduação', period:'2016 — 2020'},
          {institution:'Instituto Y', description:'Técnico em Informática', level:'Técnico', period:'2013 — 2015'}
        ],
        skills:['HTML5','CSS3','JavaScript','React','Tailwind','Git','Acessibilidade'],
        languages:[{name:'Português',level:'Nativo'},{name:'Inglês',level:'Avançado'}],
        certifications:[{name:'Scrum Fundamentals',issuer:'ScrumStudy',period:'2021'},{name:'React Developer',issuer:'Meta',period:'2023'}],
        projects:[{name:'Portfolio',link:'https://tiagopinheiro8080.github.io/',description:'Portfólio com projetos e estudos.'}]
      });
      populateForm(); renderCV(); showScreen('editor-screen');
    }

    /* -------------- RENDER CV / TEMPLATES -------------- */
    function renderCV(){
      gatherFormData(); saveState();
      const d = formData;
      const theme = colors[selectedColor];
      let html = '';

      const section = (title, content, titleClasses = `text-sm font-bold ${theme.text} tracking-wider uppercase pb-2 mb-2 border-b-2 ${theme.border}`) => {
        const has = content && (Array.isArray(content) ? content.length>0 : content.replace(/<[^>]*>/g,'').trim().length>0);
        if(!has) return '';
        return `<div class="mt-6" style="page-break-inside: avoid;"><h2 class="${titleClasses}">${title}</h2><div class="mt-2">${content}</div></div>`;
      };

      const expHtml = (itemClass='') => (d.experience||[]).map(exp=>`
        <div class="${itemClass}" style="page-break-inside: avoid;">
          <h3 class="font-bold text-md text-gray-800">${exp.title||''}</h3>
          <div class="flex justify-between text-sm text-gray-500 italic">
            <span>${exp.company||''}</span><span>${exp.period||''}</span>
          </div>
          <p class="text-sm text-gray-700 mt-1">${exp.description||''}</p>
        </div>`).join('');

      const eduHtml = (itemClass='') => (d.education||[]).map(edu=>`
        <div class="${itemClass}" style="page-break-inside: avoid;">
          <h3 class="font-bold text-md text-gray-800">${edu.description||''}${edu.level?` — <span class="font-normal text-gray-600">${edu.level}</span>`:''}</h3>
          <div class="flex justify-between text-sm text-gray-500 italic">
            <span>${edu.institution||''}</span><span>${edu.period||''}</span>
          </div>
        </div>`).join('');

      const skillsHtml = `<ul class="list-disc list-inside space-y-1">${(d.skills||[]).map(s=>`<li class="text-sm text-gray-700">${s}</li>`).join('')}</ul>`;
      const skillsHtmlDark = `<ul class="list-disc list-inside space-y-1">${(d.skills||[]).map(s=>`<li class="text-xs text-gray-300">${s}</li>`).join('')}</ul>`;
      const langsHtml = `<ul class="list-disc list-inside space-y-1">${(d.languages||[]).map(l=>`<li class="text-sm text-gray-700">${l.name||''} — ${l.level||''}</li>`).join('')}</ul>`;
      const certsHtml = `<ul class="list-disc list-inside space-y-1">${(d.certifications||[]).map(c=>`<li class="text-sm text-gray-700">${c.name||''}${c.issuer?` — ${c.issuer}`:''}${c.period?` (${c.period})`:''}</li>`).join('')}</ul>`;
      const projsHtml = (d.projects||[]).map(p=>`
        <div class="mb-2">
          <div class="flex items-center gap-2">
            <span class="font-semibold text-sm text-gray-800">${p.name||''}</span>
            ${p.link?`<span class="text-xs text-blue-600 break-all">${p.link}</span>`:''}
          </div>
          ${p.description?`<p class="text-sm text-gray-700">${p.description}</p>`:''}
        </div>`).join('');

      switch(selectedTemplate){
        /* ---- 5 ORIGINAIS ---- */
        case 'executive':
          html = `
          <div class="flex h-full text-sm">
            <aside class="w-1/3 p-8 text-white" style="background-color:#2d3748;">
              <h1 class="text-3xl font-bold leading-tight">${d.name||''}</h1>
              <p class="text-lg ${theme.text} mt-1 font-bold">${d.role||''}</p>
              <div class="mt-8 border-t border-gray-500 pt-6">
                <h2 class="text-sm font-bold uppercase tracking-widest">Contato</h2>
                <p class="text-xs mt-2 break-all">${d.email||''}</p><p class="text-xs mt-1">${d.phone||''}</p>
                <p class="text-xs mt-1 break-all">${d.linkedin||''}</p><p class="text-xs mt-1">${d.location||''}</p>
              </div>
              ${section('<span class="text-white">Habilidades</span>', skillsHtmlDark, 'text-sm font-bold text-white tracking-wider uppercase pb-2 mb-2 border-b-2 border-gray-500')}
              ${section('<span class="text-white">Idiomas</span>', langsHtml, 'text-sm font-bold text-white tracking-wider uppercase pb-2 mb-2 border-b-2 border-gray-500')}
              ${section('<span class="text-white">Certificações</span>', certsHtml, 'text-sm font-bold text-white tracking-wider uppercase pb-2 mb-2 border-b-2 border-gray-500')}
            </aside>
            <main class="w-2/3 p-8 text-gray-700 bg-white">
              ${section('Perfil Profissional', `<p>${d.summary||''}</p>`)}
              ${section('Experiência Profissional', expHtml('mb-4'))}
              ${section('Formação Acadêmica', eduHtml('mb-4'))}
              ${section('Projetos', projsHtml)}
            </main>
          </div>`; break;

        case 'modern':
          html = `
          <div class="p-10 text-gray-800 bg-white text-sm">
            <div class="text-center pb-6 border-b-2 ${theme.border}">
              <h1 class="text-5xl font-bold tracking-tight">${d.name||''}</h1>
              <p class="text-xl ${theme.text} mt-2 font-bold">${d.role||''}</p>
            </div>
            <div class="flex justify-center text-xs space-x-4 py-3 text-gray-600">
              ${(d.email && `<span>${d.email}</span>`)||''}${(d.phone && `<span>• ${d.phone}</span>`)||''}
              ${(d.linkedin && `<span>• ${d.linkedin}</span>`)||''}${(d.location && `<span>• ${d.location}</span>`)||''}
            </div>
            ${section('Resumo', `<p class="text-center max-w-2xl mx-auto">${d.summary||''}</p>`)}
            ${section('Experiência', expHtml('mb-4'))}
            ${section('Formação', eduHtml('mb-4'))}
            <div class="grid grid-cols-2 gap-8">
              ${section('Habilidades', skillsHtml)} ${section('Idiomas', langsHtml)}
            </div>
            ${section('Certificações', certsHtml)}
            ${section('Projetos', projsHtml)}
          </div>`; break;

        case 'timeline':
          html = `
          <div class="p-10 bg-white text-sm">
            <header class="relative text-center pb-8 mb-8">
              <h1 class="text-4xl font-bold text-gray-800">${d.name||''}</h1>
              <p class="text-lg font-bold ${theme.text} mt-1">${d.role||''}</p>
              <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-2/3 h-0.5 ${theme.bg}"></div>
            </header>
            <div class="grid grid-cols-3 gap-8">
              <div class="col-span-1">
                ${section('Contato', `<p>${d.email||''}</p><p>${d.phone||''}</p><p>${d.linkedin||''}</p><p>${d.location||''}</p>`)}
                ${section('Habilidades', skillsHtml)}
                ${section('Idiomas', langsHtml)}
              </div>
              <div class="col-span-2">
                ${section('Perfil', `<p>${d.summary||''}</p>`)}
                ${section('Experiência', (d.experience||[]).map(exp=>`
                    <div class="mb-4 relative pl-6" style="page-break-inside: avoid;">
                      <div class="absolute left-0 top-1.5 h-full w-0.5 ${theme.bg} opacity-30"></div>
                      <div class="absolute -left-1 top-1.5 w-3 h-3 rounded-full ${theme.bg}"></div>
                      <p class="text-xs text-gray-500">${exp.period||''}</p>
                      <h3 class="font-bold text-sm text-gray-800">${exp.title||''} ${exp.company?`em ${exp.company}`:''}</h3>
                      <p class="text-xs text-gray-600 mt-1">${exp.description||''}</p>
                    </div>`).join(''))}
                ${section('Formação', eduHtml())}
                ${section('Certificações', certsHtml)}
                ${section('Projetos', projsHtml)}
              </div>
            </div>
          </div>`; break;

        case 'creative': {
          const photo = d.photo
            ? `<img src="${d.photo}" class="w-32 h-32 rounded-full object-cover mx-auto mb-4 border-4 border-white shadow-md" alt="Foto">`
            : `<div class="w-32 h-32 rounded-full bg-gray-200 mx-auto mb-4 flex items-center justify-center text-gray-500 text-xs p-2">Selecione uma foto</div>`;
          html = `
          <div class="p-10 bg-white text-gray-800 text-sm">
            <div class="grid grid-cols-12 gap-8">
              <aside class="col-span-4">
                ${photo}
                ${section('Contato', `<p>${d.email||''}</p><p>${d.phone||''}</p><p>${d.linkedin||''}</p><p>${d.location||''}</p>`, `text-sm font-bold ${theme.text} tracking-wider uppercase`)}
                ${section('Habilidades', skillsHtml, `text-sm font-bold ${theme.text} tracking-wider uppercase`)}
                ${section('Idiomas', langsHtml, `text-sm font-bold ${theme.text} tracking-wider uppercase`)}
              </aside>
              <main class="col-span-8">
                <h1 class="text-5xl font-bold">${d.name||''}</h1>
                <p class="text-xl font-bold text-gray-500 mt-1">${d.role||''}</p>
                <div class="w-full h-1 ${theme.bg} my-4"></div>
                ${section('Perfil', `<p>${d.summary||''}</p>`, `text-sm font-bold ${theme.text} tracking-wider uppercase`)}
                ${section('Experiência', expHtml('mb-4'), `text-sm font-bold ${theme.text} tracking-wider uppercase`)}
                ${section('Formação', eduHtml('mb-4'), `text-sm font-bold ${theme.text} tracking-wider uppercase`)}
                ${section('Certificações', certsHtml, `text-sm font-bold ${theme.text} tracking-wider uppercase`)}
                ${section('Projetos', projsHtml, `text-sm font-bold ${theme.text} tracking-wider uppercase`)}
              </main>
            </div>
          </div>`; break;
        }

        case 'compact':
        default:
          html = `
          <div class="p-8 text-gray-800 bg-gray-50 text-sm">
            <div class="grid grid-cols-12 gap-8">
              <div class="col-span-8 border-r pr-8 border-gray-200">
                <h1 class="text-4xl font-bold">${d.name||''}</h1>
                <p class="text-lg font-bold ${theme.text} mt-1">${d.role||''}</p>
                ${section('Resumo Profissional', `<p>${d.summary||''}</p>`)}
                ${section('Experiência', expHtml('mb-4'))}
                ${section('Projetos', projsHtml)}
              </div>
              <aside class="col-span-4">
                ${section('Contato', `<p>${d.email||''}</p><p>${d.phone||''}</p><p>${d.linkedin||''}</p><p>${d.location||''}</p>`)}
                ${section('Formação', eduHtml('mb-2'))}
                ${section('Habilidades', skillsHtml)}
                ${section('Idiomas', langsHtml)}
                ${section('Certificações', certsHtml)}
              </aside>
            </div>
          </div>`; break;

        /* ---- 5 NOVOS ---- */
        case 'elegant':
          html = `
          <div class="p-10 bg-white text-gray-800 text-sm">
            <div class="flex items-start gap-4 mb-6">
              <div class="w-1.5 h-16 ${theme.bg} rounded"></div>
              <div>
                <h1 class="text-4xl font-bold">${d.name||''}</h1>
                <p class="text-lg ${theme.text} font-bold mt-1">${d.role||''}</p>
                <div class="text-xs mt-2 text-gray-600 space-x-2">
                  ${(d.email && `<span>${d.email}</span>`)||''}
                  ${(d.phone && `<span>• ${d.phone}</span>`)||''}
                  ${(d.linkedin && `<span>• ${d.linkedin}</span>`)||''}
                  ${(d.location && `<span>• ${d.location}</span>`)||''}
                </div>
              </div>
            </div>
            ${section('Resumo', `<p>${d.summary||''}</p>`)}
            <div class="grid grid-cols-2 gap-8">
              <div>${section('Experiência', expHtml('mb-4'))}${section('Projetos', projsHtml)}</div>
              <div>${section('Formação', eduHtml('mb-4'))}${section('Habilidades', skillsHtml)}${section('Idiomas', langsHtml)}${section('Certificações', certsHtml)}</div>
            </div>
          </div>`; break;

        case 'professional':
          html = `
          <div class="bg-white text-sm">
            <div class="${theme.bg} text-white p-8">
              <h1 class="text-4xl font-bold">${d.name||''}</h1>
              <p class="text-lg font-semibold opacity-90 mt-1">${d.role||''}</p>
              <div class="text-xs mt-2 opacity-90 space-x-2">
                ${(d.email && `<span>${d.email}</span>`)||''}
                ${(d.phone && `<span>• ${d.phone}</span>`)||''}
                ${(d.linkedin && `<span>• ${d.linkedin}</span>`)||''}
                ${(d.location && `<span>• ${d.location}</span>`)||''}
              </div>
            </div>
            <div class="p-8 text-gray-800">
              ${section('Resumo', `<p>${d.summary||''}</p>`)}
              <div class="grid grid-cols-3 gap-8">
                <div class="col-span-2">${section('Experiência', expHtml('mb-4'))}${section('Projetos', projsHtml)}</div>
                <aside class="col-span-1">${section('Formação', eduHtml('mb-4'))}${section('Habilidades', skillsHtml)}${section('Idiomas', langsHtml)}${section('Certificações', certsHtml)}</aside>
              </div>
            </div>
          </div>`; break;

        case 'photoLeft': {
          const photo = d.photo
            ? `<img src="${d.photo}" class="w-36 h-36 rounded-lg object-cover border-4 border-white shadow" alt="Foto">`
            : `<div class="w-36 h-36 rounded-lg bg-gray-200 flex items-center justify-center text-gray-500 text-xs p-2">Adicione uma foto</div>`;
          html = `
          <div class="flex h-full text-sm bg-white text-gray-800">
            <aside class="w-1/3 p-8 border-r border-gray-200">
              <div class="mb-4 flex justify-center">${photo}</div>
              ${section('Contato', `<p>${d.email||''}</p><p>${d.phone||''}</p><p>${d.linkedin||''}</p><p>${d.location||''}</p>`)}
              ${section('Habilidades', skillsHtml)}
              ${section('Idiomas', langsHtml)}
              ${section('Certificações', certsHtml)}
            </aside>
            <main class="w-2/3 p-8">
              <h1 class="text-4xl font-bold">${d.name||''}</h1>
              <p class="text-lg ${theme.text} font-bold mt-1">${d.role||''}</p>
              <div class="w-16 h-1 ${theme.bg} my-4"></div>
              ${section('Resumo', `<p>${d.summary||''}</p>`)}
              ${section('Experiência', expHtml('mb-4'))}
              ${section('Formação', eduHtml('mb-4'))}
              ${section('Projetos', projsHtml)}
            </main>
          </div>`; break;
        }

        case 'photoHeader': {
          const photo = d.photo
            ? `<img src="${d.photo}" class="w-28 h-28 rounded-full object-cover border-4 ${theme.border} shadow" alt="Foto">`
            : `<div class="w-28 h-28 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-xs p-2">Foto</div>`;
          html = `
          <div class="p-10 bg-white text-gray-800 text-sm">
            <header class="flex items-center justify-between border-b pb-6 mb-6">
              <div>
                <h1 class="text-4xl font-bold">${d.name||''}</h1>
                <p class="text-lg ${theme.text} font-bold mt-1">${d.role||''}</p>
                <div class="text-xs mt-2 text-gray-600 space-x-2">
                  ${(d.email && `<span>${d.email}</span>`)||''}
                  ${(d.phone && `<span>• ${d.phone}</span>`)||''}
                  ${(d.linkedin && `<span>• ${d.linkedin}</span>`)||''}
                  ${(d.location && `<span>• ${d.location}</span>`)||''}
                </div>
              </div>
              <div class="shrink-0">${photo}</div>
            </header>
            ${section('Resumo', `<p>${d.summary||''}</p>`)}
            <div class="grid grid-cols-3 gap-8">
              <div class="col-span-2">${section('Experiência', expHtml('mb-4'))}${section('Projetos', projsHtml)}</div>
              <aside class="col-span-1">${section('Formação', eduHtml('mb-4'))}${section('Habilidades', skillsHtml)}${section('Idiomas', langsHtml)}${section('Certificações', certsHtml)}</aside>
            </div>
          </div>`; break;
        }

        case 'photoCard': {
          const photo = d.photo
            ? `<img src="${d.photo}" class="w-full aspect-square object-cover rounded-lg border ${theme.border}" alt="Foto">`
            : `<div class="w-full aspect-square rounded-lg bg-gray-200 flex items-center justify-center text-gray-500 text-xs p-2">Foto opcional</div>`;
          html = `
          <div class="p-8 bg-white text-gray-800 text-sm">
            <div class="grid grid-cols-12 gap-8">
              <aside class="col-span-4">
                <div class="p-4 border rounded-lg">
                  ${photo}
                  <h1 class="text-2xl font-bold mt-4">${d.name||''}</h1>
                  <p class="${theme.text} font-bold">${d.role||''}</p>
                  <div class="h-0.5 ${theme.bg} my-4"></div>
                  ${section('Contato', `<p>${d.email||''}</p><p>${d.phone||''}</p><p>${d.linkedin||''}</p><p>${d.location||''}</p>`, `text-xs font-bold ${theme.text} tracking-wider uppercase`)}
                  ${section('Habilidades', skillsHtml, `text-xs font-bold ${theme.text} tracking-wider uppercase`)}
                  ${section('Idiomas', langsHtml, `text-xs font-bold ${theme.text} tracking-wider uppercase`)}
                </div>
              </aside>
              <main class="col-span-8">
                ${section('Resumo', `<p>${d.summary||''}</p>`)}
                ${section('Experiência', expHtml('mb-4'))}
                ${section('Formação', eduHtml('mb-4'))}
                ${section('Certificações', certsHtml)}
                ${section('Projetos', projsHtml)}
              </main>
            </div>
          </div>`; break;
        }
      }

      previewArea.innerHTML = html;
    }

    /* -------------- PDF (A4 com recorte correto por página) -------------- */
function setupPDF() {
    const btn = document.getElementById('download-pdf-btn');
    const { jsPDF } = window.jspdf;

    btn.addEventListener('click', async () => {
        const cv = document.getElementById('cv-preview-area');
        const original = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Gerando...';

        try {
            const pdf = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4',
                putOnlyUsedFonts: true, // Otimização
                compress: true,        // Otimização
            });

            await pdf.html(cv, {
                callback: function (pdf) {
                    const name = (formData.name || 'curriculo').replace(/\s+/g, '_');
                    pdf.save(`${name}_curriculo.pdf`);
                },
                // Margens para o conteúdo dentro do PDF
                margin: [10, 10, 10, 10], // [top, right, bottom, left]

                // A MÁGICA ACONTECE AQUI!
                // Esta opção instrui o jsPDF a quebrar a página de forma inteligente,
                // tentando não cortar o texto no meio.
                autoPaging: 'text',

                // Largura do HTML dentro do PDF (A4 tem 210mm, com margens de 10mm de cada lado)
                width: 190,
                windowWidth: cv.scrollWidth, // Usa a largura real do elemento para renderizar
            });

        } catch (error) {
            console.error('Erro ao gerar PDF:', error);
            alert('Erro ao gerar PDF. Tente novamente.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = original;
        }
    });
}

    /* -------------- INIT -------------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      updateStepper();

      templates.forEach(t=>{
        const card = document.createElement('div');
        card.className = 'template-selector-card';
        card.dataset.templateId = t.id;
        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-gray-200">${t.name}</span>
            ${t.photo ? '<span class="text-xs px-2 py-0.5 rounded bg-blue-600/30 text-blue-200 border border-blue-500/30">Foto</span>' : ''}
          </div>
          <div class="bg-[#0b1528] rounded p-2">
            <div class="h-2 bg-[#334155] rounded mb-1"></div>
            <div class="h-2 bg-[#1f2937] rounded mb-1"></div>
            <div class="h-2 w-2/3 bg-[#1f2937] rounded"></div>
          </div>`;
        card.addEventListener('click', ()=>{
          document.querySelectorAll('.template-selector-card').forEach(c=>c.classList.remove('selected'));
          card.classList.add('selected'); selectedTemplate = t.id; renderCV();
        });
        templateSelector.appendChild(card);
      });

      Object.keys(colors).forEach(c=>{
        const dot = document.createElement('button');
        dot.className = `color-selector-dot ${colors[c].bg}`;
        dot.title = c; dot.dataset.colorId = c;
        dot.addEventListener('click', ()=>{
          document.querySelectorAll('.color-selector-dot').forEach(d=>d.classList.remove('selected'));
          dot.classList.add('selected'); selectedColor = c; renderCV();
        });
        colorSelector.appendChild(dot);
      });

      document.querySelector(`.template-selector-card[data-template-id="${selectedTemplate}"]`)?.classList.add('selected');
      document.querySelector(`.color-selector-dot[data-color-id="${selectedColor}"]`)?.classList.add('selected');

      form.addEventListener('input', renderCV);
      document.getElementById('add-experience').addEventListener('click', ()=> addDynamicEntry('experience'));
      document.getElementById('add-education').addEventListener('click', ()=> addDynamicEntry('education'));
      document.getElementById('add-language').addEventListener('click', ()=> addDynamicEntry('languages'));
      document.getElementById('add-certification').addEventListener('click', ()=> addDynamicEntry('certifications'));
      document.getElementById('add-project').addEventListener('click', ()=> addDynamicEntry('projects'));
      document.getElementById('photo').addEventListener('change', handlePhotoUpload);

      loadState(); populateForm(); renderCV(); setupPDF();
    });
  </script>
</body>
</html>